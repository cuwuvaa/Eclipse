




<!doctype html>
<html lang="ru" >
    <head>
        <meta charset="utf-8"/>
        <title>Докеризация Django с помощью Postgres, Gunicorn и Nginx | Статьи о Django | Все о фреймворке Джанго и его библиотеках</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="Это пошаговое руководство подробно описывает, как настроить Django для запуска на Docker с Postgres. Для производственных сред мы добавим Nginx и Gunicorn. Мы также рассмотрим, как обслуживать статические и медиафайлы Django через Nginx. Полезные статьи и заметки о Django." />
        <meta name="yandex-verification" content="68f4641d7f454426" />
        <meta name="google-site-verification" content="9CW6iwITflBwNEW40QCIT5dW1dl7O0PCzXeXjYurY14" />
        <link rel="icon" type="image/png" href="/static/img/favicon.png">
        <link rel="shortcut icon" type="image/x-icon" href="/static/img/favicon.png">
        
        
        <link rel="stylesheet" href="/static/CACHE/css/output.57ccc8adefa8.css" type="text/css">
        
    
            
        
    <link rel="canonical" href="/articles/tutorials/dokerizaciya-django-s-pomoshyu-postgres-gunicorn-i-nginx/">

        
            <!-- Yandex.RTB -->
            <script>window.yaContextCb=window.yaContextCb||[]</script>
            <script src="https://yandex.ru/ads/system/context.js" async></script>
        
        
    <meta property="og:site_name" content="Статьи о Django | Django.Fun" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="" />
    <meta property="og:url" content="https://django.fun/articles/tutorials/dokerizaciya-django-s-pomoshyu-postgres-gunicorn-i-nginx/" />
    <meta property="og:title" content="Докеризация Django с помощью Postgres, Gunicorn и Nginx" />
    <meta property="og:description" content="Это пошаговое руководство подробно описывает, как настроить Django для запуска на Docker с Postgres. Для производственных сред мы добавим Nginx и Gunicorn. Мы также рассмотрим, как обслуживать статические и медиафайлы Django через Nginx." />
    <meta property="article:published_time" content="2021-06-21T00:00:00+02:00" />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:domain" content="django.fun" />
    <meta name="twitter:url" content="https://django.fun/articles/tutorials/dokerizaciya-django-s-pomoshyu-postgres-gunicorn-i-nginx/" />
    <meta name="twitter:title" content="Докеризация Django с помощью Postgres, Gunicorn и Nginx" />
    <meta name="twitter:description" content="Это пошаговое руководство подробно описывает, как настроить Django для запуска на Docker с Postgres. Для производственных сред мы добавим Nginx и Gunicorn. Мы также рассмотрим, как обслуживать статические и медиафайлы Django через Nginx." />

    </head>

    <body>

        <header class="header" id="header">
            <div class="header__wrapper">
                <div class="header__content">
                    <div class="header__logo">
                        <a href="/">Django.<span>fun</span></a>
                    </div>
                    <nav class="header__nav" id="header__nav">
                        <ul>
                            
                                <li>
                                    <a href="/docs/" class="header__nav__link">Документация
                                        
                                            <span>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="5.019" height="8.623" viewBox="0 0 5.019 8.623">
                                                    <g transform="translate(-1481.168 -2218.188)">
                                                        <path d="M230.571,368.7l3.958,3.958-3.958,3.958" transform="translate(1250.95 1849.842)" fill="none"></path>
                                                    </g>
                                                </svg>
                                            </span>
                                        
                                    </a>
                                    
                                        <div class="header__nav__submenu">
                                            <div class="header__nav__submenu__content">
                                                
                                                    <a href="/docs/django/stable/" class="header__nav__submenu__item">
                                                        <h6>Django - документация на русском</h6>
                                                        <p>Django (Джанго) — свободный фреймворк для веб-приложений на языке Python, использующий шаблон проектирования MVC. Документация на русском языке.</p>
                                                    </a>
                                                
                                                    <a href="/docs/python/stable/" class="header__nav__submenu__item">
                                                        <h6>Python - документация на русском</h6>
                                                        <p>Python — это простой в освоении мощный язык программирования.</p>
                                                    </a>
                                                
                                                    <a href="/docs/django-orm-cookbook/stable/" class="header__nav__submenu__item">
                                                        <h6>Рецепты Django ORM</h6>
                                                        <p>Рецепты Django ORM - это книга о работе с моделями Django ORM и Django. Django ORM является одним из ключевых столпов Django.</p>
                                                    </a>
                                                
                                                    <a href="/docs/django-rest-framework/stable/" class="header__nav__submenu__item">
                                                        <h6>Django Rest Framework</h6>
                                                        <p>Django Rest Framework (DRF) — это библиотека, которая работает со стандартными моделями Django для создания гибкого и мощного API для проекта.</p>
                                                    </a>
                                                
                                                    <a href="/docs/sqlalchemy/stable/" class="header__nav__submenu__item">
                                                        <h6>SQLAlchemy на русском</h6>
                                                        <p>SQLAlchemy — это набор инструментов Python SQL и Object Relational Mapper, который дает разработчикам приложений всю мощь и гибкость SQL.</p>
                                                    </a>
                                                
                                                    <a href="/docs/django-cms/stable/" class="header__nav__submenu__item">
                                                        <h6>Django CMS</h6>
                                                        <p>Django CMS - это современная платформа для веб-публикаций, построенная на Django, фреймворке веб-приложений «для перфекционистов с соблюдением сроков».</p>
                                                    </a>
                                                
                                                    <a href="/docs/social-docs/stable/" class="header__nav__submenu__item">
                                                        <h6>Документация по Python Social Auth</h6>
                                                        <p>Python Social Auth - это простой в настройке механизм социальной аутентификации/регистрации с поддержкой нескольких платформ и провайдеров аутентификации.</p>
                                                    </a>
                                                
                                                    <a href="/docs/celery/stable/" class="header__nav__submenu__item">
                                                        <h6>Celery</h6>
                                                        <p>Очереди задач используются как механизм распределения работы между потоками или машинами. Входом очереди задач является единица работы, называемая задачей.</p>
                                                    </a>
                                                
                                                    <a href="/docs/" class="header__nav__submenu__item">
                                                        <h6>Перейти к полному списку библиотек →</h6>
                                                        <p></p>
                                                    </a>
                                                
                                            </div>
                                        </div>
                                    
                                </li>
                            
                                <li>
                                    <a href="/articles/" class="header__nav__link">Статьи
                                        
                                            <span>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="5.019" height="8.623" viewBox="0 0 5.019 8.623">
                                                    <g transform="translate(-1481.168 -2218.188)">
                                                        <path d="M230.571,368.7l3.958,3.958-3.958,3.958" transform="translate(1250.95 1849.842)" fill="none"></path>
                                                    </g>
                                                </svg>
                                            </span>
                                        
                                    </a>
                                    
                                        <div class="header__nav__submenu">
                                            <div class="header__nav__submenu__content">
                                                
                                                    <a href="/articles/tutorials/" class="header__nav__submenu__item">
                                                        <h6>Статьи</h6>
                                                        <p>Учебники по фреймворку Django, его особенностям, случаям использования и общим полезным вещам о фреймворке.</p>
                                                    </a>
                                                
                                                    <a href="/articles/tips/" class="header__nav__submenu__item">
                                                        <h6>Советы</h6>
                                                        <p>Различные маленькие подсказки, советы, необычные применения Django - маленькие полезные вещи.</p>
                                                    </a>
                                                
                                                    <a href="/articles/videos/" class="header__nav__submenu__item">
                                                        <h6>Видеоуроки</h6>
                                                        <p>Видеоуроки по фреймворку Django, основам и использованию Python и Django.</p>
                                                    </a>
                                                
                                                    <a href="/articles/news/" class="header__nav__submenu__item">
                                                        <h6>Новости</h6>
                                                        <p>Новости Django. Будьте в курсе последних изменений и событий.</p>
                                                    </a>
                                                
                                                    <a href="/articles/python/" class="header__nav__submenu__item">
                                                        <h6>Python</h6>
                                                        <p>Учебники по Python, его функциям, применению и общим полезным вещам.</p>
                                                    </a>
                                                
                                            </div>
                                        </div>
                                    
                                </li>
                            
                                <li>
                                    <a href="/qa/" class="header__nav__link">Вопросы и ответы
                                        
                                    </a>
                                    
                                </li>
                            
                                <li>
                                    <a href="/cbv/" class="header__nav__link">Классы-представления
                                        
                                    </a>
                                    
                                </li>
                            
                        </ul>
                        <button id="header__nav__close" class="header__nav__close">✕</button>
                    </nav>
                    <button id="header__bar" class="header__bar">☰</button>
                </div>
            </div>
        </header>

        


<div class="index index__top">
    <div class="index__ad">
        
            <!-- Yandex.RTB R-A-395615-13 -->
            <div id="yandex_rtb_R-A-395615-13" class="ads__header">
                
                <div class="ads__header__content"></div>
            </div>
            <script>window.yaContextCb.push(()=>{
              Ya.Context.AdvManager.render({
                renderTo: 'yandex_rtb_R-A-395615-13',
                blockId: 'R-A-395615-13'
              })
            })</script>
        
    </div>
</div>

        <div class="df-wrapper">
            
    <div class="main main__sidebar__right">

        <div class="main__content">
            <div role="main">

                <h1>Докеризация Django с помощью Postgres, Gunicorn и Nginx</h1>
                <p>Это пошаговое руководство подробно описывает, как настроить Django для запуска на Docker с Postgres. Для производственных сред мы добавим Nginx и Gunicorn. Мы также рассмотрим, как обслуживать статические и медиафайлы Django через Nginx.</p>
<p><em>Зависимости</em>:</p>
<ol>
<li>Django v3.2.6</li>
<li>Docker v20.10.8</li>
<li>Python v3.9.6</li>
</ol>
<blockquote>
<p>Django on Docker Series:</p>
<ol>
<li>Докеризация Django с помощью Postgres, Gunicorn и Nginx</li>
<li>Защита контейнерного приложения Django с помощью Let's Encrypt</li>
<li>Развертывание Django на AWS с помощью Docker и Let's Encrypt</li>
</ol>
</blockquote>
<h2 id="project-setup">Настройка проекта</h2>
<p>Создайте новый каталог проекта вместе с новым проектом Django:</p>
<pre>
<code>$ mkdir django-on-docker &amp;&amp; cd django-on-docker
$ mkdir app &amp;&amp; cd app
$ python3.9 -m venv env
$ source env/bin/activate
(env)$

(env)$ pip install django==3.2.6
(env)$ django-admin.py startproject hello_django .
(env)$ python manage.py migrate
(env)$ python manage.py runserver </code></pre>
<blockquote>
<p>Не стесняйтесь менять virtualenv и Pip на Poetry или Pipenv. Для получения дополнительной информации просмотрите <a href="https://django.fun/tutorials/sovremennye-sredy-python-upravlenie-zavisimostyami-i-rabochim-prostranstvom/">Современные среды Python</a>.</p>
</blockquote>
<p>Перейдите по адресу <a href="http://localhost:8000/">http://localhost:8000/</a> для просмотра экрана приветствия Django. После этого завершите работу сервера. Затем выйдите из виртуальной среды и удалите ее. Теперь у нас есть простой проект Django для работы.</p>
<p>Создайте файл <strong>requirements.txt</strong> в каталоге <code>app</code> и добавьте Django в качестве зависимости:</p>
<pre>
<code>Django==3.2.6 </code></pre>
<p>Поскольку мы перейдем к Postgres, удалите файл <strong>db.sqlite3</strong> из каталога <code>app</code>.</p>
<p>Ваш каталог проекта должен выглядеть следующим образом:</p>
<pre>
<code>└── app
    ├── hello_django
    │   ├── __init__.py
    │   ├── asgi.py
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py
    ├── manage.py
    └── requirements.txt</code></pre>
<div class="index"><div class="index__ad">
    <!-- Yandex.RTB R-A-395615-4 -->
    <div id="yandex_rtb_R-A-395615-4-1" class="ads__text">
        <div class="ads__text__content"></div>
    </div>
    <script>window.yaContextCb.push(()=>{
      Ya.Context.AdvManager.render({
        renderTo: 'yandex_rtb_R-A-395615-4-1',
        blockId: 'R-A-395615-4',
        pageNumber: 1,
      })
    })</script>
</div></div><h2 id="docker">Docker</h2>
<p>Установите Docker, если у вас его еще нет, добавьте <strong>Dockerfile</strong> в каталог <code>app</code>:</p>
<pre>
<code># pull official base image
FROM python:3.9.6-alpine

# set work directory
WORKDIR /usr/src/app

# set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# install dependencies
RUN pip install --upgrade pip
COPY ./requirements.txt .
RUN pip install -r requirements.txt

# copy project
COPY . .</code></pre>
<p>Так, мы начали с <a href="https://github.com/gliderlabs/docker-alpine">Alpine</a> на основе <a href="https://hub.docker.com/_/python/">образа Docker</a> для Python 3.9.6. Затем мы установили <a href="https://docs.docker.com/engine/reference/builder/#workdir">рабочий каталог</a> и две переменные окружения:</p>
<ol>
<li><code>PYTHONDONTWRITEBYTECODE</code>: Запрещает Python записывать файлы <code>pyc</code> на диск (эквивалент опции <code>python -B</code>)</li>
<li><code>PYTHONUNBUFFERED</code>: Запрещает Python буферизовать <strong>stdout</strong> и <strong>stderr</strong> (эквивалент опции <code>python -u</code>)</li>
</ol>
<p>Наконец, мы обновили Pip, скопировали файл <em>requirements.txt</em>, установили зависимости и скопировали сам проект Django.</p>
<blockquote>
<p>Ознакомьтесь с <a href="https://mherman.org/presentations/dockercon-2018">Docker для разработчиков Python</a>, чтобы узнать больше о структурировании файлов Docker, а также о некоторых лучших практиках настройки Docker для разработки на Python.</p>
</blockquote>
<p>Затем добавьте файл <strong>docker-compose.yml</strong> в корень проекта:</p>
<pre>
<code>version: '3.8'

services:
  web:
    build: ./app
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - ./app/:/usr/src/app/
    ports:
      - 8000:8000
    env_file:
      - ./.env.dev</code></pre>
<blockquote>
<p>Review the <a href="https://docs.docker.com/compose/compose-file/">Compose file reference</a> for info on how this file works.</p>
<p>Просмотрите <a href="http://docs.docker.com/compose/compose-file/">файл Compose</a> для получения информации о том, как этот файл работает.</p>
</blockquote>
<p>Обновите переменные <code>SECRET_KEY</code>, <code>DEBUG</code> и <code>ALLOWED_HOSTS</code> в <strong>settings.py</strong>:</p>
<pre>
<code>SECRET_KEY = os.environ.get("SECRET_KEY")

DEBUG = int(os.environ.get("DEBUG", default=0))

# 'DJANGO_ALLOWED_HOSTS' should be a single string of hosts with a space between each.
# For example: 'DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]'
ALLOWED_HOSTS = os.environ.get("DJANGO_ALLOWED_HOSTS").split(" ")</code></pre>
<p>Убедитесь, что вы добавили импорт наверху:</p>
<pre>
<code>import os
</code></pre>
<p>Затем создайте файл <strong>.env.dev</strong> в корне проекта для хранения переменных среды для разработки:</p>
<pre>
<code>DEBUG=1
SECRET_KEY=foo
DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1] </code></pre>
<p>Создайте образ:</p>
<pre>
<code>$ docker-compose build </code></pre>
<p>После создания образа запустите контейнер:</p>
<pre>
<code>$ docker-compose up -d </code></pre>
<p>Перейдите по адресу <strong>http://localhost:8000/</strong>, чтобы снова просмотреть экран приветствия.</p>
<blockquote>
<p>Проверьте наличие ошибок в журналах, если это не работает, с помощью<code> docker-compose logs -f</code>.</p>
</blockquote>
<h2 id="postgres">Postgres</h2>
<p>Чтобы настроить Postgres, нам нужно добавить новую службу в файл <strong>docker-compose.yml</strong>, обновить настройки Django и установить Psycopg2.</p>
<p>Сначала добавьте новую службу <strong>db</strong> в <strong>docker-compose.yml</strong>:</p>
<pre>
<code>version: '3.8'

services:
  web:
    build: ./app
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - ./app/:/usr/src/app/
    ports:
      - 8000:8000
    env_file:
      - ./.env.dev
    depends_on:
      - db
  db:
    image: postgres:13.0-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_USER=hello_django
      - POSTGRES_PASSWORD=hello_django
      - POSTGRES_DB=hello_django_dev

volumes:
  postgres_data:</code></pre>
<p>Для сохранения данных после окончания жизни контейнера мы настроили том. Эта конфигурация привяжет <code>postgres_data</code> к директории "<strong>/var/lib/postgresql/data/</strong>" в контейнере.</p>
<p>Мы также добавили ключ среды, чтобы определить имя базы данных по умолчанию и задать имя пользователя и пароль.</p>
<blockquote>
<p>Review the "Environment Variables" section of the <a href="https://hub.docker.com/_/postgres">Postgres Docker Hub page</a> for more info.</p>
<p>Дополнительные сведения см. в разделе «<a href="http://hub.docker.com/_/postgres">Переменные среды</a>» на странице Postgres Docker Hub.</p>
</blockquote>
<p>Нам также понадобятся некоторые новые переменные среды для веб-службы, поэтому обновите <strong>.env.dev</strong> следующим образом:</p>
<pre>
<code>DEBUG=1
SECRET_KEY=foo
DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]
SQL_ENGINE=django.db.backends.postgresql
SQL_DATABASE=hello_django_dev
SQL_USER=hello_django
SQL_PASSWORD=hello_django
SQL_HOST=db
SQL_PORT=5432</code></pre>
<p>Обновите <code>ATABASES</code> в <em>settings.py</em>:</p>
<pre>
<code>DATABASES = {
    "default": {
        "ENGINE": os.environ.get("SQL_ENGINE", "django.db.backends.sqlite3"),
        "NAME": os.environ.get("SQL_DATABASE", BASE_DIR / "db.sqlite3"),
        "USER": os.environ.get("SQL_USER", "user"),
        "PASSWORD": os.environ.get("SQL_PASSWORD", "password"),
        "HOST": os.environ.get("SQL_HOST", "localhost"),
        "PORT": os.environ.get("SQL_PORT", "5432"),
    }
}</code></pre>
<p>Здесь база данных настраивается на основе переменных окружения, которые мы только что определили. Обратите внимание на значения по умолчанию.</p>
<p>Обновите <strong>Dockerfile</strong> для установки соответствующих пакетов, необходимых для Psycopg2:</p>
<pre>
<code># pull official base image
FROM python:3.9.6-alpine

# set work directory
WORKDIR /usr/src/app

# set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# install psycopg2 dependencies
RUN apk update \
    &amp;&amp; apk add postgresql-dev gcc python3-dev musl-dev

# install dependencies
RUN pip install --upgrade pip
COPY ./requirements.txt .
RUN pip install -r requirements.txt

# copy project
COPY . .</code></pre>
<p>Добавьте Psycopg2 в <strong>requirements.txt</strong>:</p>
<pre>
<code>Django==3.2.6
psycopg2-binary==2.9.1</code></pre>
<blockquote>
<p>Ознакомьтесь <a href="http://github.com/psycopg/psycopg2/issues/684">с этой проблемой на GitHub</a> для получения дополнительной информации об установке Psycopg2 в образ Docker на базе Alpine.</p>
</blockquote>
<p>Создайте новый образ и запустите два контейнера:</p>
<pre>
<code>$ docker-compose up -d --build </code></pre>
<p>Запустите миграции:</p>
<pre>
<code>$ docker-compose exec web python manage.py migrate --noinput </code></pre>
<blockquote>
<p>Получили следующую ошибку?</p>
<pre>
django.db.utils.OperationalError: FATAL: database "hello_django_dev" does not exist
</pre>
<p>Запустите <code>docker-compose down -v</code>, чтобы удалить тома вместе с контейнерами. Затем заново соберите образы, запустите контейнеры и примените миграции.</p>
</blockquote>
<p>Убедитесь, что таблицы Django по умолчанию были созданы:</p>
<pre>
<code>$ docker-compose exec db psql --username=hello_django --dbname=hello_django_dev

psql (13.0)
Type "help" for help.

hello_django_dev=# \l
                                          List of databases
       Name       |    Owner     | Encoding |  Collate   |   Ctype    |       Access privileges
------------------+--------------+----------+------------+------------+-------------------------------
 hello_django_dev | hello_django | UTF8     | en_US.utf8 | en_US.utf8 |
 postgres         | hello_django | UTF8     | en_US.utf8 | en_US.utf8 |
 template0        | hello_django | UTF8     | en_US.utf8 | en_US.utf8 | =c/hello_django              +
                  |              |          |            |            | hello_django=CTc/hello_django
 template1        | hello_django | UTF8     | en_US.utf8 | en_US.utf8 | =c/hello_django              +
                  |              |          |            |            | hello_django=CTc/hello_django
(4 rows)

hello_django_dev=# \c hello_django_dev
You are now connected to database "hello_django_dev" as user "hello_django".

hello_django_dev=# \dt
                     List of relations
 Schema |            Name            | Type  |    Owner
--------+----------------------------+-------+--------------
 public | auth_group                 | table | hello_django
 public | auth_group_permissions     | table | hello_django
 public | auth_permission            | table | hello_django
 public | auth_user                  | table | hello_django
 public | auth_user_groups           | table | hello_django
 public | auth_user_user_permissions | table | hello_django
 public | django_admin_log           | table | hello_django
 public | django_content_type        | table | hello_django
 public | django_migrations          | table | hello_django
 public | django_session             | table | hello_django
(10 rows)

hello_django_dev=# \q</code></pre>
<p>Вы можете проверить, что том был создан, выполнив:</p>
<pre>
<code>$ docker volume inspect django-on-docker_postgres_data
</code></pre>
<p>Вы должны увидеть что-то похожее на:</p>
<pre>
<code>[
    {
        "CreatedAt": "2021-08-23T15:49:08Z",
        "Driver": "local",
        "Labels": {
            "com.docker.compose.project": "django-on-docker",
            "com.docker.compose.version": "1.29.2",
            "com.docker.compose.volume": "postgres_data"
        },
        "Mountpoint": "/var/lib/docker/volumes/django-on-docker_postgres_data/_data",
        "Name": "django-on-docker_postgres_data",
        "Options": null,
        "Scope": "local"
    }
]</code></pre>
<p>Затем добавьте файл <strong>entrypoint.sh</strong> в каталог <code>app</code>, чтобы проверить работоспособность Postgres перед применением миграции и запуском сервера разработки Django:</p>
<pre>
<code>#!/bin/sh

if [ "$DATABASE" = "postgres" ]
then
    echo "Waiting for postgres..."

    while ! nc -z $SQL_HOST $SQL_PORT; do
      sleep 0.1
    done

    echo "PostgreSQL started"
fi

python manage.py flush --no-input
python manage.py migrate

exec "$@"</code></pre>
<p>Обновите разрешения файлов локально:</p>
<pre>
<code>$ chmod +x app/entrypoint.sh </code></pre>
<p>Затем обновите файл Dockerfile, чтобы скопировать файл entrypoint.sh и запустить его как команду точки входа Docker:</p>
<pre>
<code># pull official base image
FROM python:3.9.6-alpine

# set work directory
WORKDIR /usr/src/app

# set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# install psycopg2 dependencies
RUN apk update \
    &amp;&amp; apk add postgresql-dev gcc python3-dev musl-dev

# install dependencies
RUN pip install --upgrade pip
COPY ./requirements.txt .
RUN pip install -r requirements.txt

# copy entrypoint.sh
COPY ./entrypoint.sh .
RUN sed -i 's/\r$//g' /usr/src/app/entrypoint.sh
RUN chmod +x /usr/src/app/entrypoint.sh

# copy project
COPY . .

# run entrypoint.sh
ENTRYPOINT ["/usr/src/app/entrypoint.sh"]</code></pre>
<p>Добавьте переменную окружения <code>DATABASE</code> в <em>.env.dev</em>:</p>
<pre>
<code>DEBUG=1
SECRET_KEY=foo
DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]
SQL_ENGINE=django.db.backends.postgresql
SQL_DATABASE=hello_django_dev
SQL_USER=hello_django
SQL_PASSWORD=hello_django
SQL_HOST=db
SQL_PORT=5432
DATABASE=postgres</code></pre>
<p>Попробуйте еще раз:</p>
<ol>
<li>Пересоздайте образы</li>
<li>Запустите контейнеры</li>
<li>Зайдите на <a href="http://localhost:8000/">http://localhost:8000/</a></li>
</ol>
<h3 id="notes">Примечания</h3>
<p>Во-первых, несмотря на добавление Postgres, мы все еще можем создать независимый образ Docker для Django, если переменная окружения <code>DATABASE</code> не установлена на <code>postgres</code>. Чтобы проверить, создайте новый образ, а затем запустите новый контейнер:</p>
<pre>
<code>$ docker build -f ./app/Dockerfile -t hello_django:latest ./app
$ docker run -d \
    -p 8006:8000 \
    -e "SECRET_KEY=please_change_me" -e "DEBUG=1" -e "DJANGO_ALLOWED_HOSTS=*" \
    hello_django python /usr/src/app/manage.py runserver 0.0.0.0:8000</code></pre>
<p>Вы должны увидеть страницу приветствия по адресу <a href="http://localhost:8006">http://localhost:8006</a></p>
<p>Во-вторых, возможно, вы захотите закомментировать команды <code>database flush</code> и <code>migrate</code> в сценарии <strong>entrypoint.sh</strong>, чтобы они не выполнялись при каждом запуске или перезапуске контейнера:</p>
<pre>
<code>#!/bin/sh

if [ "$DATABASE" = "postgres" ]
then
    echo "Waiting for postgres..."

    while ! nc -z $SQL_HOST $SQL_PORT; do
      sleep 0.1
    done

    echo "PostgreSQL started"
fi

# python manage.py flush --no-input
# python manage.py migrate

exec "$@"</code></pre>
<p>Вместо этого вы можете запустить их вручную, после запуска контейнеров, следующим образом:</p>
<pre>
<code>$ docker-compose exec web python manage.py flush --no-input
$ docker-compose exec web python manage.py migrate </code></pre>
<h2 id="gunicorn">Gunicorn</h2>
<p>Для производственных сред добавим <a href="https://gunicorn.org/">Gunicorn</a>, WSGI-сервер промышленного класса, в файл требований:</p>
<pre>
<code>Django==3.2.6
gunicorn==20.1.0
psycopg2-binary==2.9.1 </code></pre>
<blockquote>
<p>Интересно узнать о WSGI и Gunicorn? Просмотрите главу <a href="https://testdriven.io/courses/python-web-framework/wsgi/">WSGI</a> из курса <a href="https://testdriven.io/courses/python-web-framework/">Building Your Own Python Web Framework</a>.</p>
</blockquote>
<p>Поскольку мы все еще хотим использовать встроенный сервер Django в разработке, создайте новый файл compose под названием <strong>docker-compose.prod.yml</strong> для производства:</p>
<pre>
<code>version: '3.8'

services:
  web:
    build: ./app
    command: gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000
    ports:
      - 8000:8000
    env_file:
      - ./.env.prod
    depends_on:
      - db
  db:
    image: postgres:13.0-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    env_file:
      - ./.env.prod.db

volumes:
  postgres_data:</code></pre>
<blockquote>
<p>Если у вас несколько окружений, возможно, вам стоит рассмотреть возможность использования конфигурационного файла <a href="https://docs.docker.com/compose/extends/">docker-compose.override.yml</a>. При таком подходе вы добавляете базовую конфигурацию в файл <em>docker-compose.yml</em>, а затем используете файл <em>docker-compose.override.yml</em> для переопределения настроек конфигурации в зависимости от окружения.</p>
</blockquote>
<p>Обратите внимание на <code>команду</code> по умолчанию. Мы запускаем Gunicorn, а не сервер разработки Django. Мы также удалили том из службы <strong><code>web</code></strong>, поскольку он не нужен нам в производстве. Наконец, мы используем <a href="https://docs.docker.com/compose/env-file/">отдельные файлы переменных окружения</a>, чтобы определить переменные окружения для обоих сервисов, которые будут передаваться контейнеру во время выполнения.</p>
<p><strong>.env.prod:</strong></p>
<pre>
<code>DEBUG=0
SECRET_KEY=change_me
DJANGO_ALLOWED_HOSTS=localhost 127.0.0.1 [::1]
SQL_ENGINE=django.db.backends.postgresql
SQL_DATABASE=hello_django_prod
SQL_USER=hello_django
SQL_PASSWORD=hello_django
SQL_HOST=db
SQL_PORT=5432
DATABASE=postgres</code></pre>
<p><strong>.env.prod.db:</strong></p>
<pre>
<code>POSTGRES_USER=hello_django
POSTGRES_PASSWORD=hello_django
POSTGRES_DB=hello_django_prod</code></pre>
<p>Добавьте эти два файла в корень проекта. Вы, вероятно, захотите держать их вне контроля версий, поэтому добавьте их в файл <strong>.gitignore</strong>.</p>
<p>Удалите контейнеры разработки (и связанные тома с флагом -v):</p>
<pre>
<code>$ docker-compose down -v </code></pre>
<p>Затем создайте производственные образы и запустите контейнеры:</p>
<pre>
<code>$ docker-compose -f docker-compose.prod.yml up -d --build </code></pre>
<p>Убедитесь, что база данных <code>hello_django_prod</code> была создана вместе с таблицами Django по умолчанию. Проверьте страницу администратора по адресу <a href="http://localhost:8000/admin">http://localhost:8000/admin</a>. Статические файлы больше не загружаются. Это ожидаемо, так как режим отладки выключен. Мы исправим это в ближайшее время.</p>
<blockquote>
<p>Опять же, если контейнер не запускается, проверьте наличие ошибок в журналах с помощью <code>docker-compose -f docker-compose.prod.yml logs -f</code>.</p>
</blockquote>
<div class="index"><div class="index__ad">
    <!-- Yandex.RTB R-A-395615-4 -->
    <div id="yandex_rtb_R-A-395615-4-2" class="ads__text">
        <div class="ads__text__content"></div>
    </div>
    <script>window.yaContextCb.push(()=>{
      Ya.Context.AdvManager.render({
        renderTo: 'yandex_rtb_R-A-395615-4-2',
        blockId: 'R-A-395615-4',
        pageNumber: 2,
      })
    })</script>
</div></div><h2 id="production-dockerfile">Производственный Dockerfile</h2>
<p>Заметили ли вы, что мы по-прежнему выполняем команды <code>database <a data-source-id="1" data-source-type="docs" href="/docs/django/stable/ref/django-admin#flush">flush</a></code> (которая очищает базу данных) и <code>migrate</code> при каждом запуске контейнера? Это нормально для разработки, но давайте создадим новый файл точки входа для производства.</p>
<p><strong>entrypoint.prod.sh:</strong></p>
<pre>
<code>#!/bin/sh

if [ "$DATABASE" = "postgres" ]
then
    echo "Waiting for postgres..."

    while ! nc -z $SQL_HOST $SQL_PORT; do
      sleep 0.1
    done

    echo "PostgreSQL started"
fi

exec "$@"</code></pre>
<p>Обновите разрешения файлов локально:</p>
<pre>
<code>$ chmod +x app/entrypoint.prod.sh </code></pre>
<p>Чтобы использовать этот файл, создайте новый Dockerfile с именем <strong>Dockerfile.prod</strong> для использования с производственными сборками:</p>
<pre>
<code>###########
# BUILDER #
###########

# pull official base image
FROM python:3.9.6-alpine as builder

# set work directory
WORKDIR /usr/src/app

# set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# install psycopg2 dependencies
RUN apk update \
    &amp;&amp; apk add postgresql-dev gcc python3-dev musl-dev

# lint
RUN pip install --upgrade pip
RUN pip install flake8==3.9.2
COPY . .
RUN flake8 --ignore=E501,F401 .

# install dependencies
COPY ./requirements.txt .
RUN pip wheel --no-cache-dir --no-deps --wheel-dir /usr/src/app/wheels -r requirements.txt


#########
# FINAL #
#########

# pull official base image
FROM python:3.9.6-alpine

# create directory for the app user
RUN mkdir -p /home/app

# create the app user
RUN addgroup -S app &amp;&amp; adduser -S app -G app

# create the appropriate directories
ENV HOME=/home/app
ENV APP_HOME=/home/app/web
RUN mkdir $APP_HOME
WORKDIR $APP_HOME

# install dependencies
RUN apk update &amp;&amp; apk add libpq
COPY --from=builder /usr/src/app/wheels /wheels
COPY --from=builder /usr/src/app/requirements.txt .
RUN pip install --no-cache /wheels/*

# copy entrypoint.prod.sh
COPY ./entrypoint.prod.sh .
RUN sed -i 's/\r$//g'  $APP_HOME/entrypoint.prod.sh
RUN chmod +x  $APP_HOME/entrypoint.prod.sh

# copy project
COPY . $APP_HOME

# chown all the files to the app user
RUN chown -R app:app $APP_HOME

# change to the app user
USER app

# run entrypoint.prod.sh
ENTRYPOINT ["/home/app/web/entrypoint.prod.sh"]</code></pre>
<p>Здесь мы использовали Docker <a href="https://docs.docker.com/develop/develop-images/multistage-build/">многоступенчатую сборку</a>, чтобы уменьшить конечный размер образа. По сути, <code>builder</code> - это временный образ, который используется для сборки колес Python. Затем колеса копируются в конечный производственный образ, а образ <code>builder</code> удаляется.</p>
<blockquote>
<p>Вы можете пойти по пути <a href="https://stackoverflow.com/a/53101932/1799408">многоступенчатой сборки</a> еще дальше и использовать один <em>Dockerfile</em> вместо создания двух Dockerfiles. Подумайте о плюсах и минусах использования этого подхода вместо двух разных файлов.</p>
</blockquote>
<p>Заметили ли вы, что мы создали пользователя, не являющегося root? По умолчанию Docker запускает контейнерные процессы от имени root внутри контейнера. Это плохая практика, поскольку злоумышленники могут получить root-доступ к хосту Docker, если им удастся вырваться из контейнера. Если вы являетесь root в контейнере, вы будете root на хосте.</p>
<p>Обновите веб-службу в файле <strong>docker-compose.prod.yml</strong> для сборки с помощью <strong>Dockerfile.prod</strong>:</p>
<pre>
<code>web:
  build:
    context: ./app
    dockerfile: Dockerfile.prod
  command: gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000
  ports:
    - 8000:8000
  env_file:
    - ./.env.prod
  depends_on:
    - db</code></pre>
<p>Попробуйте:</p>
<pre>
<code>$ docker-compose -f docker-compose.prod.yml down -v
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml exec web python manage.py migrate --noinput </code></pre>
<h2 id="nginx">Nginx</h2>
<p>Следующим шагом добавим Nginx, который будет работать как <a href="https://www.nginx.com/resources/glossary/reverse-proxy-server/">обратный прокси</a> для Gunicorn для обработки клиентских запросов, а также для обслуживания статических файлов.</p>
<p>Добавьте сервис в <strong>docker-compose.prod.yml</strong>:</p>
<pre>
<code>nginx:
  build: ./nginx
  ports:
    - 1337:80
  depends_on:
    - web</code></pre>
<p>Затем в локальном корне проекта создайте следующие файлы и папки:</p>
<pre>
<code>└── nginx
    ├── Dockerfile
    └── nginx.conf</code></pre>
<p><strong>Dockerfile:</strong></p>
<pre>
<code>FROM nginx:1.21-alpine

RUN rm /etc/nginx/conf.d/default.conf
COPY nginx.conf /etc/nginx/conf.d</code></pre>
<p><strong>nginx.conf:</strong></p>
<pre>
<code>upstream hello_django {
    server web:8000;
}

server {

    listen 80;

    location / {
        proxy_pass http://hello_django;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_redirect off;
    }

}</code></pre>
<blockquote>
<p>Посмотрите <a href="https://docs.nginx.com/nginx/admin-guide/web-server/app-gateway-uwsgi-django/">Using NGINX and NGINX Plus as an Application Gateway with uWSGI and Django</a> для получения дополнительной информации о настройке Nginx для работы с Django.</p>
</blockquote>
<p>Затем обновите веб-службу в <strong>docker-compose.prod.yml</strong>, заменив порты на <strong>expose</strong>:</p>
<pre>
<code>web:
  build:
    context: ./app
    dockerfile: Dockerfile.prod
  command: gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000
  expose:
    - 8000
  env_file:
    - ./.env.prod
  depends_on:
    - db</code></pre>
<p>Сейчас порт 8000 открыт только внутри системы, для других служб Docker. Порт больше не будет публиковаться на хост-машине.</p>
<blockquote>
<p>Для получения дополнительной информации о портах и экспонировании просмотрите <a href="https://stackoverflow.com/questions/40801772/what-is-the-difference-between-docker-compose-ports-vs-expose">этот</a> вопрос Stack Overflow.</p>
</blockquote>
<p>Попробуйте еще раз.</p>
<pre>
<code>$ docker-compose -f docker-compose.prod.yml down -v
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml exec web python manage.py migrate --noinput </code></pre>
<p>Убедитесь, что приложение запущено и работает на <a href="http://localhost:1337">http://localhost:1337</a>.</p>
<p>Структура вашего проекта теперь должна выглядеть следующим образом:</p>
<pre>
<code>├── .env.dev
├── .env.prod
├── .env.prod.db
├── .gitignore
├── app
│   ├── Dockerfile
│   ├── Dockerfile.prod
│   ├── entrypoint.prod.sh
│   ├── entrypoint.sh
│   ├── hello_django
│   │   ├── __init__.py
│   │   ├── asgi.py
│   │   ├── settings.py
│   │   ├── urls.py
│   │   └── wsgi.py
│   ├── manage.py
│   └── requirements.txt
├── docker-compose.prod.yml
├── docker-compose.yml
└── nginx
    ├── Dockerfile
    └── nginx.conf</code></pre>
<p>После этого выключите контейнеры:</p>
<pre>
<code>$ docker-compose -f docker-compose.prod.yml down -v </code></pre>
<p>Поскольку Gunicorn является сервером приложений, он не будет обслуживать статические файлы. Итак, как следует обрабатывать статические и медиафайлы в этой конкретной конфигурации?</p>
<h2 id="static-files">Статические файлы</h2>
<p>Обновите <em>settings.py</em>:</p>
<pre>
<code>STATIC_URL = "/static/"
STATIC_ROOT = BASE_DIR / "staticfiles" </code></pre>
<h3 id="разработка">Разработка</h3>
<p>Теперь любой запрос к <code>http://localhost:8000/static/*</code> будет обслуживаться из каталога "staticfiles".</p>
<p>Для проверки сначала пересоберите образы и запустите новые контейнеры, как обычно. Убедитесь, что статические файлы по-прежнему корректно обслуживаются по адресу <a href="http://localhost:8000/admin">http://localhost:8000/admin</a>.</p>
<h3 id="производство">Производство</h3>
<p>Для производства добавьте том в веб-службы и службы nginx в <strong>docker-compose.prod.yml</strong>, чтобы каждый контейнер имел общий каталог с именем «staticfiles»:</p>
<pre>
<code>version: '3.8'

services:
  web:
    build:
      context: ./app
      dockerfile: Dockerfile.prod
    command: gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - static_volume:/home/app/web/staticfiles
    expose:
      - 8000
    env_file:
      - ./.env.prod
    depends_on:
      - db
  db:
    image: postgres:13.0-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    env_file:
      - ./.env.prod.db
  nginx:
    build: ./nginx
    volumes:
      - static_volume:/home/app/web/staticfiles
    ports:
      - 1337:80
    depends_on:
      - web

volumes:
  postgres_data:
  static_volume:</code></pre>
<p>Нам также необходимо создать папку «/home/app/web/staticfiles» в <strong>Dockerfile.prod</strong>:</p>
<pre>
<code>...

# create the appropriate directories
ENV HOME=/home/app
ENV APP_HOME=/home/app/web
RUN mkdir $APP_HOME
RUN mkdir $APP_HOME/staticfiles
WORKDIR $APP_HOME

...</code></pre>
<p>Почему это необходимо?</p>
<p>Docker Compose обычно монтирует именованные тома от имени root. А поскольку мы используем пользователя, не являющегося root, то при выполнении команды <code>collectstatic</code>, если каталог еще не существует, мы получим ошибку отказа в разрешении.</p>
<p>Чтобы обойти это, вы можете либо:</p>
<ol>
<li>Создать папку в Dockerfile (<a href="https://github.com/docker/compose/issues/3270#issuecomment-206214034">источник</a>)</li>
<li>Измените права доступа к каталогу после его монтирования (<a href="https://stackoverflow.com/a/40510068/1799408">источник</a>)</li>
</ol>
<p>Мы использовали первый вариант.</p>
<p>Следующим образом обновите конфигурацию Nginx, чтобы направлять запросы статических файлов в папку "staticfiles":</p>
<pre>
<code>upstream hello_django {
    server web:8000;
}

server {

    listen 80;

    location / {
        proxy_pass http://hello_django;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_redirect off;
    }

    location /static/ {
        alias /home/app/web/staticfiles/;
    }

}</code></pre>
<p>Разверните контейнеры для разработки:</p>
<pre>
<code>$ docker-compose down -v </code></pre>
<p>Тест:</p>
<pre>
<code>$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml exec web python manage.py migrate --noinput
$ docker-compose -f docker-compose.prod.yml exec web python manage.py collectstatic --no-input --clear </code></pre>
<p>Опять же, запросы <code>http://localhost:1337/static/*</code> будут обслуживаться из каталога "staticfiles".</p>
<p>Перейдите по адресу http://localhost:1337/admin и убедитесь, что статические ресурсы загружаются правильно.</p>
<p>Вы также можете проверить в журналах - через <code>docker-compose -f docker-compose.prod.yml logs -f</code> - что запросы к статическим файлам успешно обрабатываются через Nginx:</p>
<pre>
<code>nginx_1  | 192.168.144.1 - - [23/Aug/2021:20:11:00 +0000] "GET /admin/ HTTP/1.1" 302 0 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36" "-"
nginx_1  | 192.168.144.1 - - [23/Aug/2021:20:11:00 +0000] "GET /admin/login/?next=/admin/ HTTP/1.1" 200 2214 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36" "-"
nginx_1  | 192.168.144.1 - - [23/Aug/2021:20:11:00 +0000] "GET /static/admin/css/base.css HTTP/1.1" 304 0 "http://localhost:1337/admin/login/?next=/admin/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36" "-"
nginx_1  | 192.168.144.1 - - [23/Aug/2021:20:11:00 +0000] "GET /static/admin/css/nav_sidebar.css HTTP/1.1" 304 0 "http://localhost:1337/admin/login/?next=/admin/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36" "-"
nginx_1  | 192.168.144.1 - - [23/Aug/2021:20:11:00 +0000] "GET /static/admin/css/responsive.css HTTP/1.1" 304 0 "http://localhost:1337/admin/login/?next=/admin/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36" "-"
nginx_1  | 192.168.144.1 - - [23/Aug/2021:20:11:00 +0000] "GET /static/admin/css/login.css HTTP/1.1" 304 0 "http://localhost:1337/admin/login/?next=/admin/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36" "-"
nginx_1  | 192.168.144.1 - - [23/Aug/2021:20:11:00 +0000] "GET /static/admin/js/nav_sidebar.js HTTP/1.1" 304 0 "http://localhost:1337/admin/login/?next=/admin/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36" "-"
nginx_1  | 192.168.144.1 - - [23/Aug/2021:20:11:00 +0000] "GET /static/admin/css/fonts.css HTTP/1.1" 304 0 "http://localhost:1337/static/admin/css/base.css" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36" "-"
nginx_1  | 192.168.144.1 - - [23/Aug/2021:20:11:00 +0000] "GET /static/admin/fonts/Roboto-Regular-webfont.woff HTTP/1.1" 304 0 "http://localhost:1337/static/admin/css/fonts.css" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36" "-"
nginx_1  | 192.168.144.1 - - [23/Aug/2021:20:11:00 +0000] "GET /static/admin/fonts/Roboto-Light-webfont.woff HTTP/1.1" 304 0 "http://localhost:1337/static/admin/css/fonts.css" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36" "-"</code></pre>
<p>После выполнения контейнеров:</p>
<pre>
<code>$ docker-compose -f docker-compose.prod.yml down -v </code></pre>
<div class="index"><div class="index__ad">
    <!-- Yandex.RTB R-A-395615-4 -->
    <div id="yandex_rtb_R-A-395615-4-3" class="ads__text">
        <div class="ads__text__content"></div>
    </div>
    <script>window.yaContextCb.push(()=>{
      Ya.Context.AdvManager.render({
        renderTo: 'yandex_rtb_R-A-395615-4-3',
        blockId: 'R-A-395615-4',
        pageNumber: 3,
      })
    })</script>
</div></div><h2 id="media-files">Медиафайлы</h2>
<p>Чтобы проверить работу с медиафайлами, начните с создания нового приложения Django:</p>
<pre>
<code>$ docker-compose up -d --build
$ docker-compose exec web python manage.py startapp upload </code></pre>
<p>Добавьте новое приложение в <code>INSTALLED_APPS</code> в <strong>settings.py</strong>:</p>
<pre>
<code>INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",

    "upload",
]</code></pre>
<p><strong>app/upload/views.py:</strong></p>
<pre>
<code>from django.shortcuts import render
from django.core.files.storage import FileSystemStorage


def image_upload(request):
    if request.method == "POST" and request.FILES["image_file"]:
        image_file = request.FILES["image_file"]
        fs = FileSystemStorage()
        filename = fs.save(image_file.name, image_file)
        image_url = fs.url(filename)
        print(image_url)
        return render(request, "upload.html", {
            "image_url": image_url
        })
    return render(request, "upload.html")</code></pre>
<p>Добавьте каталог «templates» в каталог «app/upload», а затем добавьте новый шаблон с именем <strong>upload.html</strong>:</p>
<pre>
<code>{% block content %}

  &lt;form action="{% url "upload" %}" method="post" enctype="multipart/form-data"&gt;
    {% csrf_token %}
    &lt;input type="file" name="image_file"&gt;
    &lt;input type="submit" value="submit" /&gt;
  &lt;/form&gt;

  {% if image_url %}
    &lt;p&gt;File uploaded at: &lt;a href="{{ image_url }}"&gt;{{ image_url }}&lt;/a&gt;&lt;/p&gt;
  {% endif %}

{% endblock %}</code></pre>
<p><strong>app/hello_django/urls.py:</strong></p>
<pre>
<code>from django.contrib import admin
from django.urls import path
from django.conf import settings
from django.conf.urls.static import static

from upload.views import image_upload

urlpatterns = [
    path("", image_upload, name="upload"),
    path("admin/", admin.site.urls),
]

if bool(settings.DEBUG):
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)</code></pre>
<p><strong>app/hello_django/settings.py:</strong></p>
<pre>
<code>MEDIA_URL = "/media/"
MEDIA_ROOT = BASE_DIR / "mediafiles"</code></pre>
<h3 id="development_1">Разработка</h3>
<p>Тест:</p>
<pre>
<code>$ docker-compose up -d --build </code></pre>
<p>Вы должны иметь возможность загрузить изображение по адресу <a href="http://localhost:8000/">http://localhost:8000/</a>, а затем просмотреть его по адресу <a href="http://localhost:8000/media/IMAGE_FILE_NAME">http://localhost:8000/media/IMAGE_FILE_NAME</a>.</p>
<h3 id="production_1">Производство</h3>
<p>Для производства добавьте еще один том в веб-службы и службы nginx:</p>
<pre>
<code>version: '3.8'

services:
  web:
    build:
      context: ./app
      dockerfile: Dockerfile.prod
    command: gunicorn hello_django.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - static_volume:/home/app/web/staticfiles
      - media_volume:/home/app/web/mediafiles
    expose:
      - 8000
    env_file:
      - ./.env.prod
    depends_on:
      - db
  db:
    image: postgres:13.0-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    env_file:
      - ./.env.prod.db
  nginx:
    build: ./nginx
    volumes:
      - static_volume:/home/app/web/staticfiles
      - media_volume:/home/app/web/mediafiles
    ports:
      - 1337:80
    depends_on:
      - web

volumes:
  postgres_data:
  static_volume:
  media_volume:</code></pre>
<p>Создайте каталог "/home/app/web/mediafiles" в <strong>Dockerfile.prod</strong>:</p>
<pre>
<code>...

# create the appropriate directories
ENV HOME=/home/app
ENV APP_HOME=/home/app/web
RUN mkdir $APP_HOME
RUN mkdir $APP_HOME/staticfiles
RUN mkdir $APP_HOME/mediafiles
WORKDIR $APP_HOME

...</code></pre>
<p>Обновите конфигурацию Nginx еще раз:</p>
<pre>
<code>upstream hello_django {
    server web:8000;
}

server {

    listen 80;

    location / {
        proxy_pass http://hello_django;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_redirect off;
    }

    location /static/ {
        alias /home/app/web/staticfiles/;
    }

    location /media/ {
        alias /home/app/web/mediafiles/;
    }

}</code></pre>
<p>Реконструкция:</p>
<pre>
<code>$ docker-compose down -v
 
$ docker-compose -f docker-compose.prod.yml up -d --build
$ docker-compose -f docker-compose.prod.yml exec web python manage.py migrate --noinput
$ docker-compose -f docker-compose.prod.yml exec web python manage.py collectstatic --no-input --clear </code></pre>
<p>Протестируйте его в последний раз:</p>
<ol>
<li>Загрузите изображение на <a href="http://localhost:1337/">http://localhost:1337/</a>.</li>
<li>Затем просмотрите изображение на <a href="http://localhost:1337/media/IMAGE_FILE_NAME">http://localhost:1337/media/IMAGE_FILE_NAME</a>.</li>
</ol>
<blockquote>
<p>Если вы видите ошибку <code>413 Request Entity Too Large</code>, вам нужно <a href="https://stackoverflow.com/a/28476755/1799408">увеличить максимально допустимый размер тела клиентского запроса</a> в контексте сервера или местоположения в конфигурации Nginx.</p>
<p>Пример:</p>
<pre>
location / {
    proxy_pass http://hello_django;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_redirect off;
    client_max_body_size 100M;
} </pre>
</blockquote>
<h2 id="заключение">Заключение</h2>
<p>В этом руководстве мы рассмотрели, как контейнеризировать веб-приложение Django с Postgres для разработки. Мы также создали готовый к производству файл Docker Compose, в который добавили Gunicorn и Nginx для обработки статических и мультимедийных файлов. Теперь вы можете протестировать производственную установку локально.</p>
<p>Что касается фактического развертывания в производственной среде, вы, вероятно, захотите использовать:</p>
<ol>
<li>Полностью управляемая служба базы данных, такая как RDS или Cloud SQL, вместо управления собственным экземпляром Postgres в контейнере.</li>
<li>Пользователь без полномочий root для служб db и nginx</li>
</ol>
<p>Для получения других советов по производству просмотрите <a href="https://www.reddit.com/r/django/comments/bjgod8/dockerizing_django_with_postgres_gunicorn_and/">это обсуждение</a>.</p>
<p>You can find the code in the <a href="https://github.com/testdrivenio/django-on-docker">django-on-docker</a> repo.</p>
<p>Вы можете найти код в репозитории <a href="https://github.com/testdrivenio/django-on-docker">django-on-docker</a>.</p>
<blockquote>
<p><a href="https://github.com/testdrivenio/django-on-docker/releases/tag/pipenv">Здесь</a> также доступна более старая версия кода Pipenv.</p>
</blockquote>
<p>Спасибо, что прочитали!</p>
<blockquote>
<p>Django on Docker Series:</p>
<ol>
<li>Докеризация Django с помощью Postgres, Gunicorn и Nginx</li>
<li>Защита контейнерного приложения Django с помощью Let's Encrypt</li>
<li>Развертывание Django на AWS с помощью Docker и Let's Encrypt</li>
</ol>
</blockquote>


                







                <a href="#top" class="backtotop"><i class="icon icon-chevron-up"></i> Вернуться на верх</a>
            </div>
        </div>

        <div class="main__sidebar">
            <div role="sidebar">
                <div class="main__sidebar__item">
                    <h4>Рекомендуемые записи по теме</h4>
                    
                        <p><a href="/articles/tutorials/avtomaticheskij-povtor-nevypolnennyh-zadach-celery/">Автоматический повтор невыполненных задач Celery</a></p>
                    
                        <p><a href="/articles/tutorials/asinhronnye-zadachi-s-django-i-celery/">Асинхронные задачи с Django и Celery</a></p>
                    
                        <p><a href="/articles/tutorials/obrabotka-periodicheskih-zadach-v-django-s-pomoshyu-celery-i-docker/">Обработка периодических задач в Django с помощью Celery и Docker</a></p>
                    
                        <p><a href="/articles/tutorials/sovremennye-sredy-python-upravlenie-zavisimostyami-i-rabochim-prostranstvom/">Современные среды Python - управление зависимостями и рабочим пространством</a></p>
                    
                        <p><a href="/articles/tutorials/rukovodstvo-po-zagruzke-fajlov-i-izobrazhenij-v-django/">Руководство по загрузке файлов (и изображений) в Django</a></p>
                    
                        <p><a href="/articles/tutorials/lokalnaya-razrabotka-docker-i-django-minimalnoe-poshagovoe-rukovodstvo/">Локальная разработка Docker и Django: минимальное пошаговое руководство</a></p>
                    
                        <p><a href="/articles/tutorials/kak-upravlyat-neskolkimi-sredami-razrabotki-v-rabochem-processe-django-s-pomoshyu-docker-compose/">Как управлять несколькими средами разработки в рабочем процессе Django с помощью Docker compose</a></p>
                    
                        <p><a href="/articles/tutorials/kak-obsluzhivat-prilozheniya-flask-s-pomoshyu-uwsgi-i-nginx-v-ubuntu-1804/">Как обслуживать приложения Flask с помощью uWSGI и Nginx в Ubuntu 18.04</a></p>
                    
                </div>

                
                


<div class="main__sidebar__ad">
    
        <!-- Yandex.RTB R-A-395615-3 -->
        <div id="yandex_rtb_R-A-395615-3" class="ads__sidebar">
            
            <div style="height: 42vh;"></div>
        </div>
        <script>window.yaContextCb.push(()=>{
          Ya.Context.AdvManager.render({
            renderTo: 'yandex_rtb_R-A-395615-3',
            blockId: 'R-A-395615-3'
          })
        })</script>
    
</div>


            </div>
        </div>

    </div>

        </div>
        





        <footer class="footer">

            <div class="footer__top">
                <div class="footer__top__content">
                    
                            
                                <div class="footer__top__content__column">
                                    <h4>Документация</h4>
                                    
                                        <a href="/docs/django/stable/" class="footer__top__content__column__item">
                                            <h6>Django - документация на русском</h6>
                                            <p>Django (Джанго) — свободный фреймворк для веб-приложений на языке Python, использующий шаблон проектирования MVC. Документация на русском языке.</p>
                                        </a>
                                    
                                        <a href="/docs/python/stable/" class="footer__top__content__column__item">
                                            <h6>Python - документация на русском</h6>
                                            <p>Python — это простой в освоении мощный язык программирования.</p>
                                        </a>
                                    
                                        <a href="/docs/django-orm-cookbook/stable/" class="footer__top__content__column__item">
                                            <h6>Рецепты Django ORM</h6>
                                            <p>Рецепты Django ORM - это книга о работе с моделями Django ORM и Django. Django ORM является одним из ключевых столпов Django.</p>
                                        </a>
                                    
                                        <a href="/docs/django-rest-framework/stable/" class="footer__top__content__column__item">
                                            <h6>Django Rest Framework</h6>
                                            <p>Django Rest Framework (DRF) — это библиотека, которая работает со стандартными моделями Django для создания гибкого и мощного API для проекта.</p>
                                        </a>
                                    
                                        <a href="/docs/sqlalchemy/stable/" class="footer__top__content__column__item">
                                            <h6>SQLAlchemy на русском</h6>
                                            <p>SQLAlchemy — это набор инструментов Python SQL и Object Relational Mapper, который дает разработчикам приложений всю мощь и гибкость SQL.</p>
                                        </a>
                                    
                                        <a href="/docs/django-cms/stable/" class="footer__top__content__column__item">
                                            <h6>Django CMS</h6>
                                            <p>Django CMS - это современная платформа для веб-публикаций, построенная на Django, фреймворке веб-приложений «для перфекционистов с соблюдением сроков».</p>
                                        </a>
                                    
                                        <a href="/docs/social-docs/stable/" class="footer__top__content__column__item">
                                            <h6>Документация по Python Social Auth</h6>
                                            <p>Python Social Auth - это простой в настройке механизм социальной аутентификации/регистрации с поддержкой нескольких платформ и провайдеров аутентификации.</p>
                                        </a>
                                    
                                        <a href="/docs/celery/stable/" class="footer__top__content__column__item">
                                            <h6>Celery</h6>
                                            <p>Очереди задач используются как механизм распределения работы между потоками или машинами. Входом очереди задач является единица работы, называемая задачей.</p>
                                        </a>
                                    
                                        <a href="/docs/" class="footer__top__content__column__item">
                                            <h6>Перейти к полному списку библиотек →</h6>
                                            <p></p>
                                        </a>
                                    
                                </div>
                            
                    
                            
                                <div class="footer__top__content__column">
                                    <h4>Статьи</h4>
                                    
                                        <a href="/articles/tutorials/" class="footer__top__content__column__item">
                                            <h6>Статьи</h6>
                                            <p>Учебники по фреймворку Django, его особенностям, случаям использования и общим полезным вещам о фреймворке.</p>
                                        </a>
                                    
                                        <a href="/articles/tips/" class="footer__top__content__column__item">
                                            <h6>Советы</h6>
                                            <p>Различные маленькие подсказки, советы, необычные применения Django - маленькие полезные вещи.</p>
                                        </a>
                                    
                                        <a href="/articles/videos/" class="footer__top__content__column__item">
                                            <h6>Видеоуроки</h6>
                                            <p>Видеоуроки по фреймворку Django, основам и использованию Python и Django.</p>
                                        </a>
                                    
                                        <a href="/articles/news/" class="footer__top__content__column__item">
                                            <h6>Новости</h6>
                                            <p>Новости Django. Будьте в курсе последних изменений и событий.</p>
                                        </a>
                                    
                                        <a href="/articles/python/" class="footer__top__content__column__item">
                                            <h6>Python</h6>
                                            <p>Учебники по Python, его функциям, применению и общим полезным вещам.</p>
                                        </a>
                                    
                                </div>
                            
                    
                            
                    
                            
                    
                </div>
            </div>

            <div class="footer__bottom">
                <div class="footer__bottom__content">
                    <p>© <a href="https://django.fun/">Django.Fun</a> 2017-2025</p>
                    <p class="footer__disclaimer">Django.Fun не связан с Django Software Foundation. Django - зарегистрированная торговая марка Django Software Foundation.</p>
                </div>
            </div>
        </footer>

        
    


        <script src="/static/CACHE/js/output.9d9e6a0d5c41.js"></script>
        
        
            <!-- Yandex.Metrika counter --> <script type="text/javascript" > (function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter46974723 = new Ya.Metrika({ id:46974723, clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true }); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = "https://mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks"); </script> <noscript><div><img src="https://mc.yandex.ru/watch/46974723" style="position:absolute; left:-9999px;" alt="" /></div></noscript> <!-- /Yandex.Metrika counter -->
        

    </body>
</html>
